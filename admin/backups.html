<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerenciar Backups — Dark Epoch</title>
<link rel="stylesheet" href="../style.css">
<script defer src="../script.js?v=2025-10-31"></script>
<script>
  document.addEventListener("DOMContentLoaded", requireMasterOrRedirect);
</script>
</head>
<body>
  <div class="container-menu">
    <h1 class="titulo">💾 BACKUPS — DARK EPOCH</h1>
    <p>Somente o administrador master pode criar ou restaurar backups.</p>

    <div class="menu-botoes">
      <button onclick="criarBackup()">🧩 Criar Backup Manual</button>
      <button onclick="baixarBackup()">⬇️ Baixar Backup</button>
      <button onclick="restaurarBackup()">🔁 Restaurar Backup</button>
      <button onclick="window.location='../menu.html'">Voltar</button>
    </div>

    <div id="statusBackup" style="margin-top:20px;color:#ff0000;"></div>
  </div>

<script>
// === BACKUP FUNCTIONS ===
async function criarBackup() {
  await ensureFirebase();
  const colecao = await db.collection("listas_epoch").get();
  const backup = {};
  colecao.forEach(doc => backup[doc.id] = doc.data());
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // Armazena no Firebase
  await db.collection("backups").doc(new Date().toISOString()).set({ conteudo: backup });
  document.getElementById("statusBackup").textContent = "✅ Backup salvo com sucesso!";
}

async function baixarBackup() {
  await ensureFirebase();
  const colecao = await db.collection("listas_epoch").get();
  const backup = {};
  colecao.forEach(doc => backup[doc.id] = doc.data());
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "DarkEpoch_Backup_" + new Date().toISOString().replace(/[:.]/g, "-") + ".json";
  link.click();
  document.getElementById("statusBackup").textContent = "💾 Backup baixado com sucesso!";
}

async function restaurarBackup() {
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = ".json";
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    const data = JSON.parse(text);

    await ensureFirebase();
    for (const key of Object.keys(data)) {
      await db.collection("listas_epoch").doc(key).set(data[key]);
    }

    document.getElementById("statusBackup").textContent = "✅ Backup restaurado com sucesso!";
  };
  fileInput.click();
}
</script>
</body>
</html>
